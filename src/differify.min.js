function isArray(t){return"[object Array]"===Object.prototype.toString.call(t)}function isObject(t){return!isArray(t)&&"object"==typeof t}function isString(t){return"string"==typeof t}function isFunction(t){return"function"==typeof t}function isDate(t){return"[object Date]"==Object.prototype.toString.call(t)}function isDefined(t){return void 0!==t&&null!==t}function ifNotDefinedGetDefault(t,e,r){return isDefined(t[e])?t[e]:r}function getTypes(){return{UNDEFINED:0,OBJECT:1,ARRAY:2,STRING:3,NUMBER:4,FUNCTION:5,DATE:6}}function getTypeOf(t){var e=getTypes();return isDefined(t)?isString(t)?e.STRING:isArray(t)?e.ARRAY:isDate(t)?e.DATE:isObject(t)?e.OBJECT:isFunction(t)?e.FUNCTION:e.NUMBER:e.UNDEFINED}function clone(t){if(null==t||"object"!=typeof t)return t;var e=t.constructor();for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);return e}function arrayDiff(t,e,r){function a(t){return isObject(t)?JSON.stringify(t):isArray(t)?t.toString():t+""}var n,u={},i=[];if(!(r=r||!1))return t.length!==e.length?i.push(valueData(t,e,valueStatus.MODIFIED)):t.toString()!==e.toString()&&i.push(valueData(t,e,valueStatus.MODIFIED)),i;for(var o in t)i[o]=new valueData(t[o],null,valueStatus.DELETED),void 0===u[n=a(t[o])]?u[n]={index:o,count:0}:++u[n].count;o=0;var D;for(o in e)void 0===(D=u[n=a(e[o])])?i.push(new valueData(null,e[o],valueStatus.ADDED)):0===D.count?void 0!==i[D.index]&&(i.splice(D.index,1),delete u[n]):D.count>0&&(i.push(new valueData(null,e[o],valueStatus.ADDED)),--D.count);return i}function getDiff(t,e,r,a,n){if(0===r.deep)return n.data;var u=getTypes(),i=getTypeOf(t),o=getTypeOf(e);if(i!==o)return n.aggregator(new propertyData(a,null,i===u.FUNCTION?t.toString():t,o===u.FUNCTION?e.toString():e,valueStatus.MODIFIED)),n.data;if(i===u.OBJECT&&o===u.OBJECT){var D=clone(e);for(var l in t)if(t.hasOwnProperty(l))if(e.hasOwnProperty(l)&&void 0!==e[l])if(delete D[l],i=getTypeOf(t[l]),o=getTypeOf(e[l]),i!==o)n.aggregator(new propertyData(a,l,i===u.FUNCTION?t[l].toString():t[l],o===u.FUNCTION?e[l].toString():e[l],valueStatus.MODIFIED));else{if(i===u.UNDEFINED&&o===u.UNDEFINED){t[l]!==e[l]&&n.aggregator(new propertyData(a,l,JSON.stringify(t[l]),e[l],valueStatus.MODIFIED));continue}if(i===u.DATE&&o===u.DATE){t[l].getTime()!==e[l].getTime()&&n.aggregator(new propertyData(a,l,t[l],e[l],valueStatus.MODIFIED));continue}if(i===u.ARRAY&&o===u.ARRAY){(g=n.caller.arrayDiff(t[l],e[l],r.scan.arrays)).length>0&&n.aggregator(new propertyData(a,l,t[l],g,valueStatus.MODIFIED));continue}if(i===u.OBJECT&&o===u.OBJECT){--r.deep;var f=n.caller.getDiff(t[l],e[l],r,a+"."+l,n);r.returnType&&r.returnType===returnTypes.JSON_OBJECT?n.data[l]=f:n.data=n.data.concat(f);continue}}else n.aggregator(new propertyData(a,l,t[l],null,valueStatus.DELETED));l=null;for(l in D)e.hasOwnProperty(l)&&n.aggregator(new propertyData(a,l,null,D[l],valueStatus.ADDED))}else if(i===u.DATE&&o===u.DATE)t.getTime()!==e.getTime()&&n.aggregator(new propertyData(a,l,t,e,valueStatus.MODIFIED));else if(i===u.ARRAY&&o===u.ARRAY){var g=n.caller.arrayDiff(t,e,r.scan.arrays);g.length>0&&n.aggregator(new propertyData(a,null,t,g,valueStatus.MODIFIED))}else(t=t.toString())!==(e=e.toString())&&n.aggregator(new propertyData(a,null,t,e,valueStatus.MODIFIED));return n.data}var returnTypes={ARRAY:"array",JSON_OBJECT:"json"},valueStatus={ADDED:"added",DELETED:"deleted",MODIFIED:"modified"},valueData=function(t,e,r){return{original:t,diff:e,status:r}},propertyData=function(t,e,r,a,n){return{path:""!==t&&null!==e?t+"."+e:t,property:e,value:new valueData(r,a,n)}};module.exports={arrayDiff:arrayDiff,getDiff:function(t,e,r){r=r?{deep:ifNotDefinedGetDefault(r,"deep",3),scan:ifNotDefinedGetDefault(r,"scan",{arrays:!0}),returnType:ifNotDefinedGetDefault(r,"returnType",returnTypes.JSON_OBJECT)}:{deep:3,scan:{arrays:!0},returnType:returnTypes.JSON_OBJECT},parent="$root";var a={data:null,aggregator:null,caller:this};return r.returnType===returnTypes.JSON_OBJECT?(a.data={},a.aggregator=function(t){null!==t.property?this.data[t.property]=t:this.data=t}):(a.data=[],a.aggregator=function(t){this.data.push(t)}),getDiff(t,e,r,parent,a)}};